# èˆèŒ DX å›½æœæ¸¸ç©è®°å½•è·å– - ä½¿ç”¨è¯´æ˜

## ğŸ“Œ é‡è¦æç¤º

ç”±äºå½“å‰ä»£ç è¿è¡Œåœ¨å®¹å™¨ç¯å¢ƒä¸­ï¼Œæ— æ³•ç›´æ¥è®¿é—®èˆèŒæœåŠ¡å™¨ã€‚**è¯·åœ¨ä½ çš„æœ¬åœ°ç”µè„‘ä¸Šè¿è¡Œè¿™äº›è„šæœ¬**ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡å·¥ä½œ

#### ä¸‹è½½é¡¹ç›®åˆ°æœ¬åœ°
```bash
git clone https://github.com/Astrian/mainetcn.git
cd mainetcn
```

#### æˆ–è€…ç›´æ¥ä¸‹è½½è¿™ä¸ªå·²é…ç½®å¥½çš„ç‰ˆæœ¬
å°†ä»¥ä¸‹æ–‡ä»¶å¤åˆ¶åˆ°æœ¬åœ°ï¼š
- `test_token.js` - å¿«é€Ÿæµ‹è¯•è„šæœ¬
- `get_all_data.js` - å®Œæ•´æ•°æ®è·å–è„šæœ¬

#### å®‰è£…ä¾èµ–
```bash
npm install
```

---

### 2. é…ç½®ä½ çš„ Token

ä½ å·²ç»è·å–äº† Tokenï¼š
```
ult: 12c4b77a644b9e88a14ab3957aea7703
userId: 2005990419238350
```

#### æ–¹å¼ Aï¼šç›´æ¥ä¿®æ”¹è„šæœ¬ä¸­çš„ token
ç¼–è¾‘ `test_token.js` æˆ– `get_all_data.js`ï¼Œæ‰¾åˆ°è¿™éƒ¨åˆ†ï¼š

```javascript
let token = {
  ult: 'ä½ çš„ultå€¼',
  userId: 'ä½ çš„userIdå€¼'
}
```

æ›¿æ¢ä¸ºä½ çš„å®é™… tokenã€‚

#### æ–¹å¼ Bï¼šåˆ›å»ºé…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰
åˆ›å»º `token.json` æ–‡ä»¶ï¼š

```json
{
  "ult": "12c4b77a644b9e88a14ab3957aea7703",
  "userId": "2005990419238350"
}
```

---

### 3. è¿è¡Œè„šæœ¬

#### å¿«é€Ÿæµ‹è¯•ï¼ˆæ¨èå…ˆè¿è¡Œï¼‰
```bash
node test_token.js
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- âœ… éªŒè¯ Token æ˜¯å¦æœ‰æ•ˆ
- âœ… è·å–ç©å®¶èµ„æ–™
- âœ… è·å–æœ€è¿‘ 5 æ¬¡æ¸¸ç©è®°å½•
- âœ… è·å–å‰ 5 æ¡ Master è®°å½•
- âœ… è¿”å›æ›´æ–°åçš„ Token

#### è·å–å®Œæ•´æ•°æ®
```bash
node get_all_data.js
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- ğŸ“Š è·å–ç©å®¶å®Œæ•´èµ„æ–™
- ğŸ® è·å–æœ€è¿‘ 50 æ¬¡æ¸¸ç©è®°å½•
- ğŸ¯ è·å–æ‰€æœ‰éš¾åº¦çš„æ¸¸ç©è®°å½•ï¼ˆBasic/Advanced/Expert/Master/Re:Masterï¼‰
- ğŸ’¾ è‡ªåŠ¨ä¿å­˜ä¸º JSON æ–‡ä»¶åˆ° `output/` ç›®å½•
- ğŸ”‘ ä¿å­˜æ›´æ–°åçš„ Token åˆ° `output/latest_token.json`

---

## ğŸ“Š è¾“å‡ºæ–‡ä»¶è¯´æ˜

è¿è¡Œ `get_all_data.js` åï¼Œä¼šåœ¨ `output/` ç›®å½•ç”Ÿæˆï¼š

### `maimai_data_YYYY-MM-DD.json`
å®Œæ•´çš„æ¸¸ç©æ•°æ®ï¼ŒåŒ…å«ï¼š

```json
{
  "fetchTime": "2025-11-21T...",
  "profile": {
    "username": "ä½ çš„ç”¨æˆ·å",
    "rating": 15000,
    ...
  },
  "recentPlays": [
    {
      "tracknum": "123",
      "date": "2025/11/21",
      "track": {
        "title": "æ›²å",
        "difficulty": "master",
        "dx": true
      },
      "grade": {
        "achivement": 99.5678,
        "dxscore": 450,
        "fullcombo": true,
        "rank": "SSS"
      }
    }
  ],
  "records": {
    "basic": [...],
    "advanced": [...],
    "expert": [...],
    "master": [...],
    "remaster": [...]
  },
  "updatedToken": {
    "ult": "æ–°çš„tokenå€¼",
    "userId": "ä½ çš„userId"
  }
}
```

### `latest_token.json`
æ›´æ–°åçš„ Tokenï¼Œç”¨äºä¸‹æ¬¡è¯·æ±‚ï¼š

```json
{
  "ult": "æ–°çš„ultå€¼",
  "userId": "ä½ çš„userId"
}
```

---

## ğŸ”„ Token æ›´æ–°æœºåˆ¶

**é‡è¦ï¼šæ¯æ¬¡è°ƒç”¨ API åï¼ŒæœåŠ¡å™¨éƒ½ä¼šè¿”å›æ–°çš„ Tokenã€‚**

### è‡ªåŠ¨æ›´æ–°æµç¨‹ï¼š
1. ç”¨åˆå§‹ Token è°ƒç”¨ API
2. API è¿”å›æ•°æ® + æ–° Token
3. è„šæœ¬è‡ªåŠ¨ä½¿ç”¨æ–° Token è¿›è¡Œä¸‹ä¸€æ¬¡è¯·æ±‚
4. æ‰€æœ‰è¯·æ±‚å®Œæˆåï¼Œä¿å­˜æœ€æ–°çš„ Token

### Token å¤±æ•ˆçš„æƒ…å†µï¼š
- âŒ åœ¨å¾®ä¿¡å…¬ä¼—å·ä¸­è®¿é—®äº†ã€Œæˆ‘çš„è®°å½•ã€
- âŒ åœ¨å…¶ä»–åœ°æ–¹ç™»å½•æˆ–æŸ¥çœ‹æ•°æ®
- âŒ Token è¢«å…¶ä»–ç¨‹åºä½¿ç”¨

**è§£å†³æ–¹æ³•ï¼š** é‡æ–°æŠ“åŒ…è·å–æ–° Token

---

## ğŸ“± é‡æ–°æŠ“åŒ…è·å– Token

å¦‚æœ Token å¤±æ•ˆï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é‡æ–°è·å–ï¼š

1. **æ‰“å¼€ HttpCanary**ï¼Œå¼€å§‹æŠ“åŒ…
2. **æ‰“å¼€å¾®ä¿¡** â†’ã€ŒèˆèŒ DXã€å…¬ä¼—å· â†’ ç‚¹å‡»ã€Œæˆ‘çš„è®°å½•ã€
3. åœ¨æŠ“åŒ…è®°å½•ä¸­æ‰¾åˆ° `https://maimai.wahlap.com/maimai-mobile/home/`
4. æŸ¥çœ‹å“åº”å¤´çš„ `Set-Cookie`
5. æå– `_t` å’Œ `userId` çš„å€¼
6. æ›´æ–°è„šæœ¬ä¸­çš„ token æˆ– `token.json` æ–‡ä»¶

---

## ğŸ› ï¸ è¿›é˜¶ä½¿ç”¨

### åªè·å–ç‰¹å®šéš¾åº¦çš„è®°å½•

åˆ›å»º `get_master_only.js`ï¼š

```javascript
const mainetcn = require('./index.js')

let token = {
  ult: 'ä½ çš„token',
  userId: 'ä½ çš„userId'
}

async function getMasterRecords() {
  try {
    const result = await mainetcn.record(token, 'master')
    console.log(`è·å–äº† ${result.records.length} æ¡ Master è®°å½•`)
    console.log(JSON.stringify(result.records, null, 2))
  } catch (error) {
    console.error('é”™è¯¯:', error.message)
  }
}

getMasterRecords()
```

è¿è¡Œï¼š
```bash
node get_master_only.js
```

### è·å–å•æ¬¡æ¸¸ç©è¯¦æƒ…

```javascript
const mainetcn = require('./index.js')

let token = { ult: '...', userId: '...' }

async function getPlayDetail() {
  // 1. å…ˆè·å–æœ€è¿‘æ¸¸ç©è®°å½•
  const recent = await mainetcn.recent(token)
  token = recent.token

  // 2. è·å–ç¬¬ä¸€æ¡è®°å½•çš„è¯¦æƒ…
  const trackId = recent.result[0].id
  const detail = await mainetcn.trackdetail(token, trackId)

  console.log('è¯¦ç»†ä¿¡æ¯:', JSON.stringify(detail.result, null, 2))
}

getPlayDetail()
```

### ä½¿ç”¨é…ç½®æ–‡ä»¶è¯»å– Token

```javascript
const mainetcn = require('./index.js')
const fs = require('fs')

// ä»æ–‡ä»¶è¯»å– token
let token = JSON.parse(fs.readFileSync('token.json', 'utf-8'))

async function getData() {
  const result = await mainetcn.recent(token)

  // ä¿å­˜æ›´æ–°åçš„ token
  fs.writeFileSync('token.json', JSON.stringify(result.token, null, 2))

  console.log(result.result)
}

getData()
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: è¿è¡Œæ—¶æŠ¥é”™ "Expired or incorrect token pair"
**A:** Token å·²å¤±æ•ˆï¼Œéœ€è¦é‡æ–°æŠ“åŒ…è·å–ã€‚

### Q2: æŠ¥é”™ "The server return an error"
**A:** æœåŠ¡å™¨è¿”å›é”™è¯¯ï¼Œå¯èƒ½åŸå› ï¼š
- Token æ ¼å¼é”™è¯¯
- æœåŠ¡å™¨ç»´æŠ¤ä¸­
- ç½‘ç»œè¿æ¥é—®é¢˜

### Q3: è·å–çš„æ•°æ®ä¸å®Œæ•´
**A:** å¯èƒ½æ˜¯è¯·æ±‚è¿‡å¿«è¢«æœåŠ¡å™¨é™åˆ¶ã€‚è„šæœ¬å·²åŠ å…¥ 1 ç§’å»¶è¿Ÿï¼Œå¦‚æœè¿˜æœ‰é—®é¢˜å¯ä»¥å¢åŠ å»¶è¿Ÿæ—¶é—´ã€‚

### Q4: å¦‚ä½•å¯¼å‡ºä¸º Excel/CSV æ ¼å¼ï¼Ÿ
**A:** å¯ä»¥ä½¿ç”¨ `xlsx` åº“è½¬æ¢ JSON æ•°æ®ï¼š

```bash
npm install xlsx
```

```javascript
const XLSX = require('xlsx')
const fs = require('fs')

// è¯»å– JSON æ•°æ®
const data = JSON.parse(fs.readFileSync('output/maimai_data_2025-11-21.json'))

// è½¬æ¢ä¸ºå·¥ä½œè¡¨
const ws = XLSX.utils.json_to_sheet(data.recentPlays)
const wb = XLSX.utils.book_new()
XLSX.utils.book_append_sheet(wb, ws, 'Recent Plays')

// ä¿å­˜ä¸º Excel
XLSX.writeFile(wb, 'output/maimai_recent.xlsx')
```

---

## ğŸ“š API å‚è€ƒ

### `mainetcn.gamedata(token)`
è·å–ç©å®¶èµ„æ–™ã€‚

**è¿”å›ï¼š**
```javascript
{
  result: {
    username: string,
    rating: number,
    maxRating: number,
    ...
  },
  token: { ult: string, userId: string }
}
```

### `mainetcn.recent(token)`
è·å–æœ€è¿‘ 50 æ¬¡æ¸¸ç©è®°å½•ã€‚

**è¿”å›ï¼š** æ•°ç»„ï¼ŒåŒ…å«æœ€è¿‘çš„æ¸¸ç©è®°å½•

### `mainetcn.record(token, level)`
è·å–æŒ‡å®šéš¾åº¦çš„æ¸¸ç©è®°å½•ã€‚

**å‚æ•°ï¼š**
- `level`: `'basic'`(0), `'advanced'`(1), `'expert'`(2), `'master'`(3), `'re:master'`(4), `'all'`(99)

### `mainetcn.trackdetail(token, trackId)`
è·å–å•æ¬¡æ¸¸ç©çš„è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ¯ä¸ªéŸ³ç¬¦çš„åˆ¤å®šï¼‰ã€‚

**å‚æ•°ï¼š**
- `trackId`: ä» `recent()` è¿”å›çš„ `result[i].id` è·å–

---

## ğŸ’¡ æ•°æ®åˆ†æç¤ºä¾‹

### ç»Ÿè®¡ä½ çš„ Master éš¾åº¦å¹³å‡è¾¾æˆç‡

```javascript
const data = require('./output/maimai_data_2025-11-21.json')

const masterRecords = data.records.master
const avgAchievement = masterRecords.reduce((sum, r) => sum + r.achievements, 0) / masterRecords.length

console.log(`Master å¹³å‡è¾¾æˆç‡: ${avgAchievement.toFixed(2)}%`)
```

### æ‰¾å‡ºä½ çš„æœ€é«˜åˆ†æ›²ç›®

```javascript
const topScores = data.recentPlays
  .sort((a, b) => b.grade.achivement - a.grade.achivement)
  .slice(0, 10)

console.log('Top 10 æœ€é«˜åˆ†:')
topScores.forEach((play, i) => {
  console.log(`${i+1}. ${play.track.title} - ${play.grade.achivement}%`)
})
```

---

## ğŸ”’ å®‰å…¨æç¤º

1. **ä¸è¦åˆ†äº«ä½ çš„ Token** - ç›¸å½“äºä½ çš„è´¦å·å¯†ç 
2. **å®šæœŸæ›´æ¢ Token** - ä½¿ç”¨ååœ¨å¾®ä¿¡é‡æ–°ç™»å½•å¯åˆ·æ–° Token
3. **æœ¬åœ°å­˜å‚¨** - Token æ–‡ä»¶ä¸è¦ä¸Šä¼ åˆ°å…¬å¼€çš„ Git ä»“åº“
4. **æ·»åŠ åˆ° .gitignore**:
   ```
   token.json
   output/
   ```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

- **é¡¹ç›®å·²å½’æ¡£**ï¼Œä½œè€…ä¸å†ç»´æŠ¤
- é‡åˆ°é—®é¢˜å¯ä»¥æŸ¥çœ‹ [GitHub Issues](https://github.com/Astrian/mainetcn/issues)
- è‡ªè¡Œä¿®æ”¹ä»£ç æ—¶æ³¨æ„å¤‡ä»½æ•°æ®

---

## âœ… æ€»ç»“

ä½ ç°åœ¨æ‹¥æœ‰ï¼š
- âœ… **test_token.js** - å¿«é€Ÿæµ‹è¯•è„šæœ¬
- âœ… **get_all_data.js** - å®Œæ•´æ•°æ®è·å–è„šæœ¬
- âœ… **æœ‰æ•ˆçš„ Token** - å·²ä»æŠ“åŒ…ä¸­æå–
- âœ… **è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜** - æœ¬æ–‡æ¡£

**ä¸‹ä¸€æ­¥ï¼š**
1. å°†é¡¹ç›®ä¸‹è½½åˆ°æœ¬åœ°ç”µè„‘
2. å®‰è£…ä¾èµ– `npm install`
3. è¿è¡Œ `node test_token.js` æµ‹è¯•
4. è¿è¡Œ `node get_all_data.js` è·å–å®Œæ•´æ•°æ®
5. åœ¨ `output/` ç›®å½•æŸ¥çœ‹ç»“æœ

ç¥ä½ ç©å¾—å¼€å¿ƒï¼ğŸ®
